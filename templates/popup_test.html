<!-- templates/popup_test.html -->
<!DOCTYPE html>
<html>
<head>
    <title>ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ¥ç¶šãƒ†ã‚¹ãƒˆ</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { padding: 10px 20px; margin: 10px; font-size: 16px; }
        #result { border: 1px solid #ccc; padding: 10px; margin-top: 20px; max-height: 400px; overflow-y: scroll; }
        .log { margin: 5px 0; padding: 5px; background: #f9f9f9; }
    </style>
</head>
<body>
    <h1>ğŸ” ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ¥ç¶šç¢ºèªãƒ†ã‚¹ãƒˆ</h1>
    
    <p><strong>ç¾åœ¨ã®URL:</strong> <span id="current-url"></span></p>
    
    <button onclick="testBasicJS()">1. JavaScriptåŸºæœ¬ãƒ†ã‚¹ãƒˆ</button>
    <button onclick="testBasicPopup()">2. åŸºæœ¬ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ†ã‚¹ãƒˆ</button>
    <button onclick="testGooglePopup()">3. Googleæ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
    <button onclick="testCrossOriginDetection()">4. ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³æ¤œè¨¼ãƒ†ã‚¹ãƒˆ</button>
    <button onclick="testSameOriginPopup()">5. åŒä¸€ã‚ªãƒªã‚¸ãƒ³ãƒ†ã‚¹ãƒˆ</button>

    <div id="result">
        <div class="log">ãƒ†ã‚¹ãƒˆçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</div>
    </div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const resultDiv = document.getElementById('result');
            const logDiv = document.createElement('div');
            logDiv.className = 'log';
            logDiv.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.innerHTML = `[${timestamp}] ${message}`;
            resultDiv.appendChild(logDiv);
            resultDiv.scrollTop = resultDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        // 1. JavaScriptåŸºæœ¬ãƒ†ã‚¹ãƒˆ
        function testBasicJS() {
            log('=== JavaScriptåŸºæœ¬ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            try {
                log('âœ… JavaScriptå®Ÿè¡Œä¸­', 'success');
                log(`ç¾åœ¨URL: ${window.location.href}`);
                log(`ãƒ—ãƒ­ãƒˆã‚³ãƒ«: ${window.location.protocol}`);
                log(`ãƒ–ãƒ©ã‚¦ã‚¶: ${navigator.userAgent.substring(0, 50)}...`);
                
                // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºãƒ†ã‚¹ãƒˆ
                if (confirm('ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºãƒ†ã‚¹ãƒˆ - OKã‚’æŠ¼ã—ã¦ãã ã•ã„')) {
                    log('âœ… ã‚¢ãƒ©ãƒ¼ãƒˆ/confirmå‹•ä½œç¢ºèª', 'success');
                } else {
                    log('âŒ confirm ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ', 'error');
                }
                
            } catch (error) {
                log(`âŒ JavaScriptåŸºæœ¬ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // 2. åŸºæœ¬ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ†ã‚¹ãƒˆ
        function testBasicPopup() {
            log('=== åŸºæœ¬ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            try {
                log('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ã“ã†ã¨ã—ã¦ã„ã¾ã™...');
                
                const popup = window.open('about:blank', 'testPopup', 'width=400,height=300');
                
                if (popup) {
                    log('âœ… ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ä½œæˆæˆåŠŸ', 'success');
                    
                    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã«å†…å®¹ã‚’æ›¸ãè¾¼ã¿
                    popup.document.write(`
                        <html>
                        <head><title>ãƒ†ã‚¹ãƒˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—</title></head>
                        <body>
                            <h1>ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ†ã‚¹ãƒˆæˆåŠŸ!</h1>
                            <p>ã“ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°ã€åŸºæœ¬çš„ãªãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ã¯å‹•ä½œã—ã¦ã„ã¾ã™ã€‚</p>
                            <button onclick="window.close()">é–‰ã˜ã‚‹</button>
                        </body>
                        </html>
                    `);
                    
                    // 5ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã‚‹
                    setTimeout(() => {
                        if (!popup.closed) {
                            popup.close();
                            log('5ç§’çµŒé - ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º');
                        }
                    }, 5000);
                    
                    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®çŠ¶æ…‹ç›£è¦–
                    const checkInterval = setInterval(() => {
                        if (popup.closed) {
                            log('âœ… ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸ', 'success');
                            clearInterval(checkInterval);
                        }
                    }, 500);
                    
                } else {
                    log('âŒ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ', 'error');
                    log('ğŸ’¡ ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¦ãã ã•ã„');
                }
            } catch (error) {
                log(`âŒ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // 3. Googleæ¥ç¶šãƒ†ã‚¹ãƒˆ
        function testGooglePopup() {
            log('=== Googleæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            try {
                log('Googleãƒšãƒ¼ã‚¸ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ã“ã†ã¨ã—ã¦ã„ã¾ã™...');
                
                const popup = window.open(
                    'https://www.google.com', 
                    'googleTest', 
                    'width=600,height=500,scrollbars=yes,resizable=yes'
                );
                
                if (popup) {
                    log('âœ… Googleãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ä½œæˆæˆåŠŸ', 'success');
                    
                    let checkCount = 0;
                    const maxChecks = 10;
                    
                    const checkInterval = setInterval(() => {
                        checkCount++;
                        
                        if (popup.closed) {
                            log('âœ… Googleãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸ', 'success');
                            clearInterval(checkInterval);
                        } else if (checkCount >= maxChecks) {
                            log(`${maxChecks}ç§’çµŒé - ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º`);
                            popup.close();
                            clearInterval(checkInterval);
                        } else {
                            log(`Googleæ¥ç¶šç¢ºèªä¸­... (${checkCount}/${maxChecks})`);
                        }
                    }, 1000);
                    
                } else {
                    log('âŒ Googleãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ', 'error');
                    log('ğŸ’¡ ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¦ãã ã•ã„');
                }
            } catch (error) {
                log(`âŒ Googleæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.onload = function() {
            document.getElementById('current-url').textContent = window.location.href;
            log('ğŸš€ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº† - ãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†', 'success');
            
            // ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãƒã‚§ãƒƒã‚¯
            if (window.location.protocol === 'file:') {
                log('âš ï¸ è­¦å‘Š: file://ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§é–‹ã‹ã‚Œã¦ã„ã¾ã™', 'error');
                log('ğŸ’¡ http://localhost:8000/ ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„', 'error');
            } else {
                log('âœ… HTTPãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§æ­£å¸¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã¦ã„ã¾ã™', 'success');
            }
        };
        function testCrossOriginDetection() {
        log('=== ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³æ¤œè¨¼ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
        
        const popup = window.open('https://www.google.com', 'crossOriginTest', 'width=600,height=500');
        
        if (popup) {
            log('âœ… ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ä½œæˆæˆåŠŸ');
            
            let checkCount = 0;
            const startTime = Date.now();
            
            const detailedCheck = setInterval(() => {
                checkCount++;
                const elapsed = Date.now() - startTime;
                
                try {
                    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®è©³ç´°çŠ¶æ…‹ç¢ºèª
                    const isClosed = popup.closed;
                    const hasWindow = !!popup.window;
                    
                    log(`[${checkCount}] ${elapsed}msçµŒé:`);
                    log(`  - popup.closed: ${isClosed}`);
                    log(`  - popup.window: ${hasWindow}`);
                    
                    // URLã‚¢ã‚¯ã‚»ã‚¹ã‚’è©¦è¡Œï¼ˆã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã®ãŒæ­£å¸¸ï¼‰
                    try {
                        const url = popup.location.href;
                        log(`  - popup.location.href: ${url}`);
                    } catch (urlError) {
                        log(`  - URLå–å¾—ã‚¨ãƒ©ãƒ¼: ${urlError.name} (ã“ã‚Œã¯æ­£å¸¸)`);
                    }
                    
                    // å®Ÿéš›ã«é–‰ã˜ã‚‰ã‚ŒãŸå ´åˆ
                    if (isClosed) {
                        log('ğŸ”´ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒå®Ÿéš›ã«é–‰ã˜ã‚‰ã‚Œã¾ã—ãŸ', 'error');
                        clearInterval(detailedCheck);
                        return;
                    }
                    
                    // 10ç§’å¾Œã«å¼·åˆ¶çµ‚äº†
                    if (checkCount >= 10) {
                        log('â° 10ç§’çµŒé - ãƒ†ã‚¹ãƒˆçµ‚äº†');
                        log('ğŸ’¡ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã¯é–‹ã„ãŸã¾ã¾ã§ã™ãŒã€é€šä¿¡çŠ¶æ…‹ã‚’ç¢ºèªã§ãã¾ã—ãŸ');
                        popup.close();
                        clearInterval(detailedCheck);
                    }
                    
                } catch (error) {
                    log(`âŒ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    clearInterval(detailedCheck);
                }
            }, 1000);
            
        } else {
            log('âŒ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ', 'error');
        }
    }

    // 5. åŒä¸€ã‚ªãƒªã‚¸ãƒ³ãƒ†ã‚¹ãƒˆï¼ˆæ¯”è¼ƒç”¨ï¼‰
    function testSameOriginPopup() {
        log('=== åŒä¸€ã‚ªãƒªã‚¸ãƒ³ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
        
        // åŒã˜ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ã
        const popup = window.open('/hello/', 'sameOriginTest', 'width=400,height=300');
        
        if (popup) {
            log('âœ… åŒä¸€ã‚ªãƒªã‚¸ãƒ³ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ä½œæˆæˆåŠŸ');
            
            let checkCount = 0;
            
            const sameOriginCheck = setInterval(() => {
                checkCount++;
                
                try {
                    const isClosed = popup.closed;
                    
                    // åŒä¸€ã‚ªãƒªã‚¸ãƒ³ãªã®ã§URLã‚‚å–å¾—å¯èƒ½
                    try {
                        const url = popup.location.href;
                        log(`[${checkCount}] popup.closed: ${isClosed}, URL: ${url}`);
                    } catch (urlError) {
                        log(`[${checkCount}] popup.closed: ${isClosed}, URLå–å¾—ã‚¨ãƒ©ãƒ¼: ${urlError.message}`);
                    }
                    
                    if (isClosed) {
                        log('âœ… åŒä¸€ã‚ªãƒªã‚¸ãƒ³ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸ', 'success');
                        clearInterval(sameOriginCheck);
                    } else if (checkCount >= 10) {
                        log('â° 10ç§’çµŒé - åŒä¸€ã‚ªãƒªã‚¸ãƒ³ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã¾ã™');
                        popup.close();
                        clearInterval(sameOriginCheck);
                    }
                    
                } catch (error) {
                    log(`âŒ åŒä¸€ã‚ªãƒªã‚¸ãƒ³ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    clearInterval(sameOriginCheck);
                }
            }, 1000);
            
        } else {
            log('âŒ åŒä¸€ã‚ªãƒªã‚¸ãƒ³ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ', 'error');
        }
    }
    </script>
</body>
</html>