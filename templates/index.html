<!-- templates/index.html - å®Œå…¨ãƒ‡ãƒãƒƒã‚°ç‰ˆ -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Action Item Bot - å®Œå…¨ãƒ‡ãƒãƒƒã‚°ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .warning { color: orange; }
        button { margin: 5px; padding: 10px 15px; font-size: 14px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; border: none; }
        .btn-secondary { background: #6c757d; color: white; border: none; }
        .btn-danger { background: #dc3545; color: white; border: none; }
        #debug-info { background: #f5f5f5; padding: 10px; border-radius: 5px; max-height: 500px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .hidden { display: none; }
        .status-good { background: #d4edda; padding: 10px; border-radius: 5px; }
        .status-bad { background: #f8d7da; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– Action Item Bot - å®Œå…¨ãƒ‡ãƒãƒƒã‚°ç‰ˆ</h1>
        
        <div class="section">
            <h3>ğŸ” èªè¨¼</h3>
            <div id="login-section">
                <button id="login-redirect-btn" class="btn-primary">Googleã§ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰</button>
                <button onclick="simulateFlaskAuth()" class="btn-secondary">Flaskæ–¹å¼ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="checkCurrentUser()" class="btn-secondary">ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª</button>
            </div>
            <div id="user-section" class="hidden">
                <div id="user-info"></div>
                <button onclick="getTokenInfo()" class="btn-secondary">ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±å–å¾—</button>
                <button onclick="testDjangoAuth()" class="btn-primary">Djangoèªè¨¼ãƒ†ã‚¹ãƒˆ</button>
                <button id="logout-btn" class="btn-danger">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
            <div id="auth-status">ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹: ç¢ºèªä¸­...</div>
        </div>

        <div class="section">
            <h3>ğŸ”§ è©³ç´°ãƒ‡ãƒãƒƒã‚°</h3>
            <button onclick="debugFirebaseState()" class="btn-secondary">FirebaseçŠ¶æ…‹è©³ç´°ç¢ºèª</button>
            <button onclick="debugLocalStorage()" class="btn-secondary">ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç¢ºèª</button>
            <button onclick="forceRedirectAuth()" class="btn-secondary">ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼å¼·åˆ¶å†è©¦è¡Œ</button>
            <button onclick="checkAuthPersistence()" class="btn-secondary">èªè¨¼æ°¸ç¶šåŒ–è¨­å®šç¢ºèª</button>
            <button onclick="testNetworkConnectivity()" class="btn-secondary">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
            <br>
            <button onclick="clearPendingRedirect()" class="btn-danger">Pending Redirect ã‚¯ãƒªã‚¢</button>
            <button onclick="debugRedirectState()" class="btn-secondary">ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆçŠ¶æ…‹ç¢ºèª</button>
            <button onclick="improvedRedirectAuth()" class="btn-primary">æ”¹è‰¯ç‰ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼</button>
            <button onclick="forceManualRedirect()" class="btn-secondary">æ‰‹å‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ</button>
        </div>

        <div class="section">
            <h3>ğŸ“‹ Action Items</h3>
            <div id="action-items">
                <p>ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«Action Itemsã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
            </div>
            <button id="load-items-btn" class="hidden btn-primary">Action Itemså–å¾—</button>
        </div>

        <div class="section">
            <h3>ğŸ” ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</h3>
            <button onclick="clearDebug()" class="btn-secondary">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
            <button onclick="exportDebugLog()" class="btn-secondary">ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            <div id="debug-info"></div>
        </div>
    </div>

    <script>
        // Firebaseè¨­å®š
        const firebaseConfig = {
        apiKey: "AIzaSyApiM3EVSaJ_P3xjVS-UB2exXDT6lI3DRk",
        authDomain: "fir-test-87458.firebaseapp.com",
        projectId: "fir-test-87458",
        storageBucket: "fir-test-87458.firebasestorage.app",
        messagingSenderId: "562807781193",
        appId: "1:562807781193:web:3559d480d5b371114ccc98"
        };

        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        let debugLogHistory = [];

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            
            console.log(logEntry);
            debugLogHistory.push({ timestamp, message, type });
            
            const debugDiv = document.getElementById('debug-info');
            debugDiv.innerHTML += `<div class="${className}">${logEntry}</div>`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }

        function clearDebug() {
            document.getElementById('debug-info').innerHTML = '';
            debugLogHistory = [];
        }

        function exportDebugLog() {
            const logText = debugLogHistory.map(entry => 
                `[${entry.timestamp}] (${entry.type.toUpperCase()}) ${entry.message}`
            ).join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `debug-log-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // UIæ›´æ–°
        function updateUI(user) {
            const loginSection = document.getElementById('login-section');
            const userSection = document.getElementById('user-section');
            const authStatus = document.getElementById('auth-status');
            const userInfo = document.getElementById('user-info');
            const loadItemsBtn = document.getElementById('load-items-btn');

            if (user) {
                loginSection.classList.add('hidden');
                userSection.classList.remove('hidden');
                loadItemsBtn.classList.remove('hidden');
                
                authStatus.innerHTML = `<div class="status-good"><strong>âœ… ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹: ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿</strong></div>`;
                userInfo.innerHTML = `
                    <div class="status-good">
                        ğŸ‘¤ <strong>${user.displayName || 'åå‰ãªã—'}</strong><br>
                        ğŸ“§ ${user.email}<br>
                        ğŸ†” ${user.uid}<br>
                        â° æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³: ${user.metadata.lastSignInTime}<br>
                        ğŸ”— ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼: ${user.providerData.map(p => p.providerId).join(', ')}
                    </div>
                `;
                
                debugLog(`âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: ${user.email}`, 'success');
            } else {
                loginSection.classList.remove('hidden');
                userSection.classList.add('hidden');
                loadItemsBtn.classList.add('hidden');
                
                authStatus.innerHTML = `<div class="status-bad"><strong>âŒ ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹: æœªãƒ­ã‚°ã‚¤ãƒ³</strong></div>`;
                userInfo.innerHTML = '';
                
                debugLog('âŒ æœªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹');
            }
        }

        // FirebaseçŠ¶æ…‹è©³ç´°ç¢ºèª
        function debugFirebaseState() {
            debugLog('=== FirebaseçŠ¶æ…‹è©³ç´°ç¢ºèª ===');
            
            try {
                // Firebase ã‚¢ãƒ—ãƒªæƒ…å ±
                const app = firebase.app();
                debugLog(`âœ… Firebase ã‚¢ãƒ—ãƒªå: ${app.name}`, 'success');
                debugLog(`âœ… Firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID: ${app.options.projectId}`, 'success');
                debugLog(`âœ… Firebase authDomain: ${app.options.authDomain}`, 'success');
                
                // Auth ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æƒ…å ±
                debugLog(`Auth ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹: ${auth ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}`);
                debugLog(`ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${auth.currentUser ? 'âœ… ' + auth.currentUser.email : 'âŒ ãªã—'}`);
                
                // AuthçŠ¶æ…‹è©³ç´°
                if (auth.currentUser) {
                    const user = auth.currentUser;
                    debugLog(`ãƒ¦ãƒ¼ã‚¶ãƒ¼UID: ${user.uid}`);
                    debugLog(`ãƒ¦ãƒ¼ã‚¶ãƒ¼å: ${user.displayName || 'ãªã—'}`);
                    debugLog(`ãƒ¡ãƒ¼ãƒ«èªè¨¼æ¸ˆã¿: ${user.emailVerified ? 'ã¯ã„' : 'ã„ã„ãˆ'}`);
                    debugLog(`ä½œæˆæ—¥æ™‚: ${user.metadata.creationTime}`);
                    debugLog(`æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³: ${user.metadata.lastSignInTime}`);
                }
                
                // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆçµæœã®å†ç¢ºèª
                debugLog('ğŸ”„ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆçµæœã®å†ç¢ºèªä¸­...');
                auth.getRedirectResult()
                    .then((result) => {
                        if (result && result.user) {
                            debugLog(`âœ… å†ç¢ºèªçµæœ: ${result.user.email}`, 'success');
                            debugLog(`èªè¨¼æ–¹æ³•: ${result.credential ? result.credential.providerId : 'Unknown'}`);
                        } else {
                            debugLog('â„¹ï¸ å†ç¢ºèªçµæœ: æ–°è¦èªè¨¼ãªã—');
                        }
                    })
                    .catch((error) => {
                        debugLog(`âŒ å†ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    });
                    
            } catch (error) {
                debugLog(`âŒ FirebaseçŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç¢ºèª
        function debugLocalStorage() {
            debugLog('=== ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç¢ºèª ===');
            
            try {
                // Firebaseé–¢é€£ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ç¢ºèª
                const keys = Object.keys(localStorage);
                const firebaseKeys = keys.filter(key => 
                    key.includes('firebase') || 
                    key.includes('auth') || 
                    key.includes('user') ||
                    key.includes('gapi') ||
                    key.includes('google')
                );
                
                debugLog(`ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼ç·æ•°: ${keys.length}`);
                debugLog(`Firebase/Authé–¢é€£ã‚­ãƒ¼æ•°: ${firebaseKeys.length}`);
                
                if (firebaseKeys.length > 0) {
                    debugLog('ğŸ” Firebaseé–¢é€£ã‚­ãƒ¼:', 'info');
                    firebaseKeys.forEach(key => {
                        const value = localStorage.getItem(key);
                        debugLog(`  ğŸ“¦ ${key}: ${value ? `${value.substring(0, 50)}...` : 'null'}`);
                    });
                } else {
                    debugLog('âš ï¸ Firebaseé–¢é€£ã®ãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚ã‚Šã¾ã›ã‚“', 'warning');
                }
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚‚ç¢ºèª
                const sessionKeys = Object.keys(sessionStorage);
                const firebaseSessionKeys = sessionKeys.filter(key => 
                    key.includes('firebase') || 
                    key.includes('auth') ||
                    key.includes('google')
                );
                
                debugLog(`ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ Firebaseé–¢é€£ã‚­ãƒ¼æ•°: ${firebaseSessionKeys.length}`);
                
                if (firebaseSessionKeys.length > 0) {
                    firebaseSessionKeys.forEach(key => {
                        const value = sessionStorage.getItem(key);
                        debugLog(`  ğŸ“¦ Session ${key}: ${value ? `${value.substring(0, 30)}...` : 'null'}`);
                    });
                }
                
            } catch (error) {
                debugLog(`âŒ ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª
        function checkCurrentUser() {
            debugLog('=== ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª ===');
            
            const user = auth.currentUser;
            if (user) {
                debugLog(`âœ… ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œå‡º:`, 'success');
                debugLog(`  - åå‰: ${user.displayName || 'ãªã—'}`);
                debugLog(`  - ãƒ¡ãƒ¼ãƒ«: ${user.email}`);
                debugLog(`  - UID: ${user.uid}`);
                debugLog(`  - èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼: ${user.providerData.map(p => p.providerId).join(', ')}`);
                debugLog(`  - ãƒ¡ãƒ¼ãƒ«èªè¨¼: ${user.emailVerified ? 'æ¸ˆã¿' : 'æœªæ¸ˆã¿'}`);
                debugLog(`  - ä½œæˆæ—¥: ${user.metadata.creationTime}`);
                debugLog(`  - æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³: ${user.metadata.lastSignInTime}`);
                updateUI(user);
            } else {
                debugLog('âŒ ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã—', 'error');
                updateUI(null);
            }
        }

        // ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±å–å¾—
        async function getTokenInfo() {
            debugLog('=== ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±å–å¾—é–‹å§‹ ===');
            
            const user = auth.currentUser;
            if (!user) {
                debugLog('âŒ ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“', 'error');
                return null;
            }

            try {
                debugLog('ğŸ”„ IDãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ä¸­...');
                const idToken = await user.getIdToken(true); // forceRefresh = true
                
                debugLog('âœ… IDãƒˆãƒ¼ã‚¯ãƒ³å–å¾—æˆåŠŸ', 'success');
                debugLog(`ãƒˆãƒ¼ã‚¯ãƒ³é•·: ${idToken.length} æ–‡å­—`);
                debugLog(`ãƒˆãƒ¼ã‚¯ãƒ³é–‹å§‹: ${idToken.substring(0, 50)}...`);
                debugLog(`ãƒˆãƒ¼ã‚¯ãƒ³çµ‚äº†: ...${idToken.substring(idToken.length - 20)}`);
                
                // ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ã‚’è¡¨ç¤º
                try {
                    const tokenParts = idToken.split('.');
                    const payload = JSON.parse(atob(tokenParts[1]));
                    const exp = new Date(payload.exp * 1000);
                    const iat = new Date(payload.iat * 1000);
                    debugLog(`ğŸ• ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œæ™‚åˆ»: ${iat.toLocaleString()}`);
                    debugLog(`â° ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™: ${exp.toLocaleString()}`);
                    debugLog(`ğŸ¢ ç™ºè¡Œè€…: ${payload.iss}`);
                    debugLog(`ğŸ¯ å¯¾è±¡è€…: ${payload.aud}`);
                    debugLog(`ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${payload.sub}`);
                } catch (parseError) {
                    debugLog(`âš ï¸ ãƒˆãƒ¼ã‚¯ãƒ³è§£æã‚¨ãƒ©ãƒ¼: ${parseError.message}`, 'warning');
                }
                
                return idToken;
                
            } catch (error) {
                debugLog(`âŒ ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                return null;
            }
        }

        // Djangoèªè¨¼ãƒ†ã‚¹ãƒˆ
        async function testDjangoAuth() {
            debugLog('=== Djangoèªè¨¼ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            const idToken = await getTokenInfo();
            if (!idToken) {
                debugLog('âŒ ãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ã§ããªã„ãŸã‚ä¸­æ–­', 'error');
                return;
            }

            try {
                debugLog('ğŸ“¤ Django APIãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...');
                debugLog(`ğŸ“ ãƒªã‚¯ã‚¨ã‚¹ãƒˆURL: ${window.location.origin}/protected/`);
                debugLog(`ğŸ”‘ Authorization: Bearer ${idToken.substring(0, 20)}...`);
                
                const response = await fetch('/protected/', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + idToken,
                        'Content-Type': 'application/json'
                    }
                });

                debugLog(`ğŸ“¥ Django APIãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    debugLog('âœ… Djangoèªè¨¼æˆåŠŸ!', 'success');
                    debugLog(`ğŸ‰ Djangoå¿œç­”: ${JSON.stringify(data, null, 2)}`);
                    
                    // Action Itemsè‡ªå‹•å–å¾—
                    setTimeout(() => {
                        loadActionItems();
                    }, 1000);
                } else {
                    const errorData = await response.json();
                    debugLog(`âŒ Djangoèªè¨¼å¤±æ•—: ${JSON.stringify(errorData)}`, 'error');
                }
                
            } catch (error) {
                debugLog(`âŒ Django APIé€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // Pending RedirectçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
        function clearPendingRedirect() {
            debugLog('=== Pending Redirect ã‚¯ãƒªã‚¢é–‹å§‹ ===');
            
            try {
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰pendingRedirecté–¢é€£ã‚’å‰Šé™¤
                const keysToRemove = [];
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    if (key && key.includes('firebase:pendingRedirect')) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => {
                    sessionStorage.removeItem(key);
                    debugLog(`ğŸ—‘ï¸ å‰Šé™¤: ${key}`);
                });
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã‚‚å¿µã®ãŸã‚å‰Šé™¤
                const localKeysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.includes('firebase:pendingRedirect')) {
                        localKeysToRemove.push(key);
                    }
                }
                
                localKeysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                    debugLog(`ğŸ—‘ï¸ ãƒ­ãƒ¼ã‚«ãƒ«å‰Šé™¤: ${key}`);
                });
                
                debugLog('âœ… Pending Redirect ã‚¯ãƒªã‚¢å®Œäº†', 'success');
                debugLog('ğŸ’¡ ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼ã‚’å†è©¦è¡Œã—ã¦ãã ã•ã„', 'info');
                
            } catch (error) {
                debugLog(`âŒ Pending Redirect ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆçŠ¶æ…‹ã®è©³ç´°ç¢ºèª
        function debugRedirectState() {
            debugLog('=== ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆçŠ¶æ…‹è©³ç´°ç¢ºèª ===');
            
            try {
                // pendingRedirecté–¢é€£ã®è©³ç´°ç¢ºèª
                const pendingRedirectKeys = [];
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç¢ºèª
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    if (key && key.includes('pendingRedirect')) {
                        const value = sessionStorage.getItem(key);
                        pendingRedirectKeys.push({key, value, storage: 'session'});
                    }
                }
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç¢ºèª
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.includes('pendingRedirect')) {
                        const value = localStorage.getItem(key);
                        pendingRedirectKeys.push({key, value, storage: 'local'});
                    }
                }
                
                if (pendingRedirectKeys.length > 0) {
                    debugLog(`âš ï¸ Pending RedirectçŠ¶æ…‹ã‚’æ¤œå‡º: ${pendingRedirectKeys.length}ä»¶`, 'warning');
                    pendingRedirectKeys.forEach(item => {
                        debugLog(`  ğŸ“¦ [${item.storage}] ${item.key}: ${item.value}`);
                    });
                    debugLog('ğŸ’¡ ã“ã‚ŒãŒãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼ã®å•é¡Œã®åŸå› ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™', 'warning');
                } else {
                    debugLog('âœ… Pending RedirectçŠ¶æ…‹ãªã—', 'success');
                }
                
                // ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆåˆ¶é™ç¢ºèª
                debugLog('ğŸ” ãƒ–ãƒ©ã‚¦ã‚¶ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆåˆ¶é™ç¢ºèª...');
                try {
                    // ãƒ†ã‚¹ãƒˆç”¨ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå®Ÿè¡Œï¼ˆå®Ÿéš›ã«ã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ãªã„ï¼‰
                    const testUrl = 'https://accounts.google.com/o/oauth2/v2/auth?test=true';
                    debugLog(`ãƒ†ã‚¹ãƒˆURL: ${testUrl}`);
                    debugLog('ğŸ’¡ ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã‚„ã‚¢ãƒ‰ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ãŒãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’å¦¨ã’ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
                } catch (redirectError) {
                    debugLog(`ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${redirectError.message}`, 'error');
                }
                
            } catch (error) {
                debugLog(`âŒ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆçŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // å¼·åˆ¶çš„ãªãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼ï¼ˆç›´æ¥URLã§ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰
        function forceManualRedirect() {
            debugLog('=== å¼·åˆ¶æ‰‹å‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ ===');
            
            try {
                // Google OAuth URLã‚’æ‰‹å‹•ã§æ§‹ç¯‰
                const clientId = "562807781193-e56rginda0pqnaebqup1moasoj7d6n2q.apps.googleusercontent.com"; // ä»®ã®å€¤ã€å®Ÿéš›ã¯OAuth Client IDãŒå¿…è¦
                const redirectUri = encodeURIComponent(window.location.origin);
                const scope = encodeURIComponent('openid email profile');
                const responseType = 'code';
                
                const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                    `client_id=${clientId}&` +
                    `redirect_uri=${redirectUri}&` +
                    `scope=${scope}&` +
                    `response_type=${responseType}&` +
                    `state=${Date.now()}`;
                
                debugLog('ğŸš€ æ‰‹å‹•ã§Googleèªè¨¼URLã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™...');
                debugLog(`èªè¨¼URL: ${authUrl.substring(0, 100)}...`);
                
                // è­¦å‘Šè¡¨ç¤º
                if (confirm('æ‰‹å‹•ã§Googleèªè¨¼ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                    window.location.href = authUrl;
                }
                
            } catch (error) {
                debugLog(`âŒ æ‰‹å‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // æ”¹è‰¯ã•ã‚ŒãŸãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ï¼‰
        async function improvedRedirectAuth() {
            debugLog('=== æ”¹è‰¯ç‰ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼ ===');
            
            try {
                // ã¾ãšæ—¢å­˜ã®pending stateã‚’ã‚¯ãƒªã‚¢
                clearPendingRedirect();
                
                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼ã‚’å®Ÿè¡Œ
                setTimeout(async () => {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    provider.addScope('email');
                    provider.addScope('profile');
                    
                    // ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                    provider.setCustomParameters({
                        'prompt': 'select_account'
                    });
                    
                    debugLog('ğŸš€ æ”¹è‰¯ç‰ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼é–‹å§‹...');
                    debugLog('ğŸ’¡ èªè¨¼å¾Œã€ã“ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã£ã¦ãã¾ã™');
                    
                    try {
                        await auth.signInWithRedirect(provider);
                        debugLog('âœ… ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼ã‚³ãƒãƒ³ãƒ‰é€ä¿¡å®Œäº†', 'success');
                    } catch (redirectError) {
                        debugLog(`âŒ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼ã‚³ãƒãƒ³ãƒ‰ã‚¨ãƒ©ãƒ¼: ${redirectError.message}`, 'error');
                        
                        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—èªè¨¼ã‚’è©¦è¡Œ
                        debugLog('ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—èªè¨¼ã‚’è©¦è¡Œ...');
                        try {
                            const result = await auth.signInWithPopup(provider);
                            debugLog('âœ… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯èªè¨¼æˆåŠŸ!', 'success');
                            debugLog(`ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${result.user.email}`);
                        } catch (popupError) {
                            debugLog(`âŒ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯èªè¨¼å¤±æ•—: ${popupError.message}`, 'error');
                        }
                    }
                }, 1000);
                
            } catch (error) {
                debugLog(`âŒ æ”¹è‰¯ç‰ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // Flaskæ–¹å¼ã§ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ†ã‚¹ãƒˆ
        function simulateFlaskAuth() {
            debugLog('=== Flaskæ–¹å¼èªè¨¼ãƒ†ã‚¹ãƒˆ ===');
            
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('email');
            provider.addScope('profile');
            
            debugLog('ğŸ”„ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—èªè¨¼å®Ÿè¡Œä¸­...');
            
            // Flaskç‰ˆã¨åŒã˜ã‚·ãƒ³ãƒ—ãƒ«ãªæ–¹å¼
            auth.signInWithPopup(provider)
                .then((result) => {
                    debugLog('âœ… Flaskæ–¹å¼èªè¨¼æˆåŠŸ!', 'success');
                    debugLog(`ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${result.user.email}`);
                    debugLog(`ğŸ”— ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼: ${result.credential ? result.credential.providerId : 'Unknown'}`);
                    
                    // IDãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
                    return result.user.getIdToken();
                })
                .then((idToken) => {
                    debugLog('âœ… IDãƒˆãƒ¼ã‚¯ãƒ³å–å¾—æˆåŠŸ', 'success');
                    debugLog(`ğŸ« ãƒˆãƒ¼ã‚¯ãƒ³é•·: ${idToken.length}`);
                    
                    // Django API ãƒ†ã‚¹ãƒˆ
                    return fetch('/protected/', {
                        method: 'GET',
                        headers: {
                            'Authorization': 'Bearer ' + idToken
                        }
                    });
                })
                .then((response) => response.json())
                .then((data) => {
                    if (data.error) {
                        debugLog(`âŒ Django API ã‚¨ãƒ©ãƒ¼: ${data.error}`, 'error');
                    } else {
                        debugLog('âœ… Django API æˆåŠŸ!', 'success');
                        debugLog(`ğŸ‰ å¿œç­”: ${JSON.stringify(data)}`);
                    }
                })
                .catch((error) => {
                    debugLog(`âŒ Flaskæ–¹å¼ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.code || error.message}`, 'error');
                    
                    if (error.code === 'auth/popup-closed-by-user') {
                        debugLog('ğŸ’¡ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å•é¡ŒãŒå†ç¾ã•ã‚Œã¾ã—ãŸ - ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³åˆ¶é™ãŒåŸå› ');
                    } else if (error.code === 'auth/popup-blocked') {
                        debugLog('ğŸ’¡ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ - ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                    }
                });
        }

        // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼ã®å¼·åˆ¶å†è©¦è¡Œ
        function forceRedirectAuth() {
            debugLog('=== ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼å¼·åˆ¶å†è©¦è¡Œ ===');
            
            // ç¾åœ¨ã®èªè¨¼çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
            debugLog('ğŸ”„ æ—¢å­˜èªè¨¼çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢ä¸­...');
            auth.signOut().then(() => {
                debugLog('âœ… æ—¢å­˜èªè¨¼çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢');
                
                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼
                setTimeout(() => {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    provider.addScope('email');
                    provider.addScope('profile');
                    
                    debugLog('ğŸš€ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼ã‚’å†å®Ÿè¡Œã—ã¾ã™...');
                    debugLog('ğŸ’¡ Googleèªè¨¼ç”»é¢ã«ç§»å‹•ã—ã¾ã™ã€‚èªè¨¼å®Œäº†å¾Œã€ã“ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã£ã¦ãã¾ã™ã€‚');
                    
                    auth.signInWithRedirect(provider)
                        .catch((error) => {
                            debugLog(`âŒ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼é–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                        });
                }, 1000);
            });
        }

        // Firebaseèªè¨¼ã®æ°¸ç¶šåŒ–è¨­å®šç¢ºèª
        function checkAuthPersistence() {
            debugLog('=== èªè¨¼æ°¸ç¶šåŒ–è¨­å®šç¢ºèª ===');
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ°¸ç¶šåŒ–è¨­å®šã‚’ç¢ºèª
            auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                .then(() => {
                    debugLog('âœ… èªè¨¼æ°¸ç¶šåŒ–è¨­å®š: LOCAL (ãƒ–ãƒ©ã‚¦ã‚¶çµ‚äº†å¾Œã‚‚ä¿æŒ)', 'success');
                })
                .catch((error) => {
                    debugLog(`âŒ èªè¨¼æ°¸ç¶šåŒ–è¨­å®šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                });
        }

        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testNetworkConnectivity() {
            debugLog('=== ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãƒ†ã‚¹ãƒˆ ===');
            
            try {
                // Google APIsæ¥ç¶šãƒ†ã‚¹ãƒˆ
                debugLog('ğŸ”„ Google APIsæ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...');
                const googleResponse = await fetch('https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=test', { mode: 'no-cors' });
                debugLog('âœ… Google APIsåˆ°é”å¯èƒ½', 'success');
                
                // Firebase APIsæ¥ç¶šãƒ†ã‚¹ãƒˆ
                debugLog('ğŸ”„ Firebase APIsæ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...');
                const firebaseResponse = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:lookup?key=${firebaseConfig.apiKey}`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ idToken: 'test' })
                });
                debugLog(`Firebase APIså¿œç­”: ${firebaseResponse.status}`, firebaseResponse.status < 500 ? 'success' : 'error');
                
                // Django APIæ¥ç¶šãƒ†ã‚¹ãƒˆ
                debugLog('ğŸ”„ Django APIæ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...');
                const djangoResponse = await fetch('/api/action-items/');
                debugLog(`Django APIå¿œç­”: ${djangoResponse.status}`, djangoResponse.ok ? 'success' : 'warning');
                
            } catch (error) {
                debugLog(`âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼
        document.getElementById('login-redirect-btn').onclick = improvedRedirectAuth;

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        document.getElementById('logout-btn').onclick = () => {
            debugLog('=== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆé–‹å§‹ ===');
            auth.signOut().then(() => {
                debugLog('âœ… ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Œäº†', 'success');
            });
        };

        // Action Itemså–å¾—
        document.getElementById('load-items-btn').onclick = loadActionItems;

        async function loadActionItems() {
            debugLog('=== Action Itemså–å¾—é–‹å§‹ ===');
            
            try {
                const response = await fetch('/api/action-items/');
                const data = await response.json();
                
                if (response.ok) {
                    debugLog(`âœ… Action Itemså–å¾—æˆåŠŸ: ${data.items.length}ä»¶`, 'success');
                    
                    const itemsDiv = document.getElementById('action-items');
                    if (data.items.length === 0) {
                        itemsDiv.innerHTML = '<p>ğŸ“ Action ItemãŒã‚ã‚Šã¾ã›ã‚“ã€‚<a href="/admin/" target="_blank">ç®¡ç†ç”»é¢</a>ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>';
                    } else {
                        let html = '<h4>ğŸ“‹ Action Items:</h4>';
                        data.items.forEach((item, index) => {
                            const status = item.completed ? 'âœ…' : 'â°';
                            html += `<div style="margin: 10px 0; padding: 10px; border-left: 3px solid ${item.completed ? '#4CAF50' : '#FF9800'};">`;
                            html += `<strong>${status} ${item.title}</strong><br>`;
                            html += `æ‹…å½“: ${item.assigned_to} | æœŸé™: ${item.due_date}<br>`;
                            if (item.description) {
                                html += `è©³ç´°: ${item.description}`;
                            }
                            html += '</div>';
                        });
                        itemsDiv.innerHTML = html;
                    }
                } else {
                    debugLog(`âŒ Action Itemså–å¾—ã‚¨ãƒ©ãƒ¼: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                debugLog(`âŒ Action Itemså–å¾—å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
        window.onload = function() {
            debugLog('=== ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº† ===', 'success');
            debugLog(`ğŸŒ ç¾åœ¨URL: ${window.location.href}`);
            debugLog(`ğŸ“„ ãƒªãƒ•ã‚¡ãƒ©ãƒ¼: ${document.referrer || 'ãªã—'}`);
            debugLog(`ğŸ• èª­ã¿è¾¼ã¿æ™‚åˆ»: ${new Date().toLocaleString()}`);
            
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç¢ºèª
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.toString()) {
                debugLog(`ğŸ” URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: ${urlParams.toString()}`);
            }

            // ãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±
            debugLog(`ğŸŒ ãƒ–ãƒ©ã‚¦ã‚¶: ${navigator.userAgent.substring(0, 80)}...`);
            debugLog(`ğŸ” ã‚»ã‚­ãƒ¥ã‚¢æ¥ç¶š: ${location.protocol === 'https:' ? 'ã¯ã„' : 'ã„ã„ãˆ'}`);

            // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼ã®çµæœã‚’ç¢ºèª
            debugLog('=== ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼çµæœç¢ºèªé–‹å§‹ ===');
            
            auth.getRedirectResult()
                .then((result) => {
                    if (result && result.user) {
                        debugLog('ğŸ‰ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼æˆåŠŸ!', 'success');
                        debugLog(`ğŸ‘¤ èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${result.user.email}`);
                        debugLog(`ğŸ”— èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼: ${result.credential ? result.credential.providerId : 'Unknown'}`);
                        debugLog(`ğŸ• èªè¨¼æ™‚åˆ»: ${new Date().toLocaleString()}`);
                        
                        // è‡ªå‹•çš„ã«Djangoèªè¨¼ã‚’ãƒ†ã‚¹ãƒˆ
                        setTimeout(() => {
                            testDjangoAuth();
                        }, 1500);
                        
                    } else {
                        debugLog('â„¹ï¸ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼çµæœ: æ–°è¦èªè¨¼ãªã—');
                        
                        // æ—¢å­˜ã®ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
                        setTimeout(() => {
                            checkCurrentUser();
                        }, 1000);
                    }
                })
                .catch((error) => {
                    debugLog(`âŒ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼ã‚¨ãƒ©ãƒ¼: ${error.code} - ${error.message}`, 'error');
                    
                    // è©³ç´°ãªã‚¨ãƒ©ãƒ¼åˆ†æ
                    if (error.code === 'auth/unauthorized-domain') {
                        debugLog('ğŸ’¡ ãƒ’ãƒ³ãƒˆ: Firebase Consoleã§æ‰¿èªæ¸ˆã¿ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'warning');
                    } else if (error.code === 'auth/operation-not-allowed') {
                        debugLog('ğŸ’¡ ãƒ’ãƒ³ãƒˆ: Firebase Consoleã§Googleèªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„', 'warning');
                    }
                });

            // èªè¨¼çŠ¶æ…‹å¤‰æ›´ã®ç›£è¦–
            auth.onAuthStateChanged((user) => {
                debugLog('ğŸ”„ èªè¨¼çŠ¶æ…‹å¤‰æ›´æ¤œå‡º');
                updateUI(user);
            });

            // åˆæœŸåŒ–å®Œäº†å¾Œã®è¨­å®šç¢ºèª
            setTimeout(() => {
                debugLog('=== åˆæœŸåŒ–å®Œäº†å¾Œã®ç¢ºèª ===');
                checkAuthPersistence();
                debugFirebaseState();
            }, 2000);
        };
    </script>
</body>
</html>