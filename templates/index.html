<!-- templates/index.html - å‹•ä½œã™ã‚‹Flaskç‰ˆã«åˆã‚ã›ãŸä¿®æ­£ç‰ˆ -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Action Item Bot</title>
    <!-- Firebase v9 compatç‰ˆï¼ˆFlaskç‰ˆã¨åŒã˜ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button {
            margin: 5px;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
        }
        #debug-info {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– Action Item Bot</h1>
        
        <div class="section">
            <h3>ğŸ” èªè¨¼</h3>
            <div id="login-section">
                <button id="login-btn">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button id="test-btn">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
            </div>
            <div id="user-section" class="hidden">
                <p id="user-info"></p>
                <button id="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
            <p id="auth-status">ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹: æœªãƒ­ã‚°ã‚¤ãƒ³</p>
        </div>

        <div class="section">
            <h3>ğŸ“‹ Action Items</h3>
            <div id="action-items">
                <p>ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«Action Itemsã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
            </div>
            <button id="load-items-btn" class="hidden">Action Itemså–å¾—</button>
        </div>

        <div class="section">
            <h3>ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h3>
            <button onclick="clearDebug()">ã‚¯ãƒªã‚¢</button>
            <div id="debug-info"></div>
        </div>
    </div>

    <script>
        // Firebaseè¨­å®šï¼ˆå®Œå…¨ç‰ˆï¼‰
         const firebaseConfig = {
          apiKey: "AIzaSyApiM3EVSaJ_P3xjVS-UB2exXDT6lI3DRk",
          authDomain: "fir-test-87458.firebaseapp.com",
          projectId: "fir-test-87458",
          storageBucket: "fir-test-87458.firebasestorage.app",
          messagingSenderId: "562807781193",
          appId: "1:562807781193:web:3559d480d5b371114ccc98"
        };

        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            
            console.log(`[${timestamp}] ${message}`);
            
            const debugDiv = document.getElementById('debug-info');
            debugDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }

        function clearDebug() {
            document.getElementById('debug-info').innerHTML = '';
        }

        // UIæ›´æ–°
        function updateUI(user) {
            const loginSection = document.getElementById('login-section');
            const userSection = document.getElementById('user-section');
            const authStatus = document.getElementById('auth-status');
            const userInfo = document.getElementById('user-info');
            const loadItemsBtn = document.getElementById('load-items-btn');

            if (user) {
                loginSection.classList.add('hidden');
                userSection.classList.remove('hidden');
                loadItemsBtn.classList.remove('hidden');
                
                authStatus.innerHTML = `<span class="success">ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹: ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿</span>`;
                userInfo.innerHTML = `ğŸ‘¤ ${user.displayName} (${user.email})`;
                
                debugLog(`âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: ${user.email}`, 'success');
            } else {
                loginSection.classList.remove('hidden');
                userSection.classList.add('hidden');
                loadItemsBtn.classList.add('hidden');
                
                authStatus.innerHTML = `ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹: æœªãƒ­ã‚°ã‚¤ãƒ³`;
                userInfo.innerHTML = '';
                
                debugLog('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Œäº†');
            }
        }

        // Googleãƒ­ã‚°ã‚¤ãƒ³
        document.getElementById('login-btn').onclick = async () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                const result = await auth.signInWithPopup(provider);
                alert(`ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: ${result.user.email}`);
            } catch (error) {
                alert(`ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ${error.code} - ${error.message}`);
            }
        };

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        document.getElementById('logout-btn').onclick = () => {
            debugLog('=== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆé–‹å§‹ ===');
            auth.signOut();
        };

        // æ¥ç¶šãƒ†ã‚¹ãƒˆ
        document.getElementById('test-btn').onclick = () => {
            debugLog('=== æ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            debugLog(`Firebaseæ¥ç¶š: ${firebase.apps.length > 0 ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}`);
            debugLog(`AuthçŠ¶æ…‹: ${auth.currentUser ? 'âœ… ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿' : 'âŒ æœªãƒ­ã‚°ã‚¤ãƒ³'}`);
            debugLog(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID: ${firebaseConfig.projectId}`);
            debugLog(`èªè¨¼ãƒ‰ãƒ¡ã‚¤ãƒ³: ${firebaseConfig.authDomain}`);
        };

        // Action Itemså–å¾—
        document.getElementById('load-items-btn').onclick = loadActionItems;

        async function loadActionItems() {
            debugLog('=== Action Itemså–å¾—é–‹å§‹ ===');
            
            try {
                const response = await fetch('/api/action-items/');
                const data = await response.json();
                
                if (response.ok) {
                    debugLog(`âœ… Action Itemså–å¾—æˆåŠŸ: ${data.items.length}ä»¶`, 'success');
                    
                    const itemsDiv = document.getElementById('action-items');
                    if (data.items.length === 0) {
                        itemsDiv.innerHTML = '<p>ğŸ“ Action ItemãŒã‚ã‚Šã¾ã›ã‚“ã€‚<a href="/admin/" target="_blank">ç®¡ç†ç”»é¢</a>ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>';
                    } else {
                        let html = '<h4>ğŸ“‹ Action Items:</h4>';
                        data.items.forEach((item, index) => {
                            const status = item.completed ? 'âœ…' : 'â°';
                            html += `<div style="margin: 10px 0; padding: 10px; border-left: 3px solid ${item.completed ? '#4CAF50' : '#FF9800'};">`;
                            html += `<strong>${status} ${item.title}</strong><br>`;
                            html += `æ‹…å½“: ${item.assigned_to} | æœŸé™: ${item.due_date}<br>`;
                            if (item.description) {
                                html += `è©³ç´°: ${item.description}`;
                            }
                            html += '</div>';
                        });
                        itemsDiv.innerHTML = html;
                    }
                } else {
                    debugLog(`âŒ Action Itemså–å¾—ã‚¨ãƒ©ãƒ¼: ${data.error}`, 'error');
                }
            } catch (error) {
                debugLog(`âŒ Action Itemså–å¾—å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
        auth.onAuthStateChanged((user) => {
            debugLog('ğŸ”„ èªè¨¼çŠ¶æ…‹å¤‰æ›´æ¤œå‡º');
            updateUI(user);
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
        window.onload = function() {
            debugLog('=== ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº† ===');
            debugLog(`URL: ${window.location.href}`);
            debugLog(`User Agent: ${navigator.userAgent}`);
            
            // åˆæœŸçŠ¶æ…‹ç¢ºèª
            setTimeout(() => {
                debugLog('=== åˆæœŸçŠ¶æ…‹ç¢ºèª ===');
                debugLog(`Firebase Apps: ${firebase.apps.length}`);
                debugLog(`ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${auth.currentUser ? auth.currentUser.email : 'ãªã—'}`);
            }, 1000);
        };
    </script>
</body>
</html>